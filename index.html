<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi's Asset Forest</title>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&family=Noto+Sans+TC:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --text-color: #2f3e35;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0; min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 2s ease-in-out;
            visibility: hidden; /* 密碼輸入前隱藏 */
        }

        /* 疊加一層淡淡的紙張紋理感 */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/handmade-paper.png');
            opacity: 0.2; pointer-events: none; z-index: -1;
        }

        .container { width: 95%; max-width: 1200px; text-align: center; position: relative; }

        /* 書法標題 */
        h1 {
            font-family: 'ZCOOL XiaoWei', serif;
            font-size: 4.5rem; margin: 0; letter-spacing: 12px;
            color: var(--text-color);
            text-shadow: 2px 2px 8px rgba(255,255,255,0.8);
        }

        .progress-bar-text { font-size: 14px; opacity: 0.7; margin-bottom: 20px; font-weight: 500; }

        /* --- 背景背景森林層 (與總進度連動) --- */
        .ambient-layer {
            position: absolute; top: 150px; left: 0; width: 100%; height: 350px;
            z-index: 0; pointer-events: none;
            display: flex; flex-wrap: wrap; justify-content: center; align-content: flex-end;
            gap: 5px;
        }
        .progress-tree { transition: transform 0.5s ease; animation: sway 3s infinite ease-in-out; }

        /* --- 核心景觀區 (前景) --- */
        .landscape {
            position: relative; z-index: 1; height: 500px;
            display: flex; align-items: flex-end; justify-content: space-around;
            padding: 0 50px;
        }

        /* --- 噴水池 --- */
        .fountain-unit { width: 250px; text-align: center; }
        .fountain-img { width: 220px; height: auto; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); transition: all 1s ease; }
        .cash-status { font-size: 13px; color: #507ba6; font-weight: bold; margin-top: 10px; background: rgba(255,255,255,0.6); padding: 2px 8px; border-radius: 10px; display: inline-block; }

        /* --- 果樹區 --- */
        .orchard { flex-grow: 1; display: flex; align-items: flex-end; justify-content: center; gap: 30px; }
        .tree-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; }
        .tree-wrapper:nth-child(even) { margin-bottom: 40px; } /* 交錯排列防止標籤撞到 */

        .tree-img { filter: drop-shadow(0 15px 25px rgba(0,0,0,0.15)); transition: transform 0.3s ease; }
        .tree-img:hover { transform: scale(1.05); }

        .stock-label {
            background: rgba(255,255,255,0.85); padding: 6px 15px; border-radius: 20px;
            font-size: 11px; border: 1px solid #eee; margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); white-space: nowrap;
        }
        .fertilize-tag { color: #d62828; font-weight: bold; margin-left: 5px; animation: blink 1s infinite; }

        /* --- 告示牌 --- */
        .signpost-area { margin-top: 40px; display: flex; justify-content: center; }
        .signboard {
            width: 500px; height: 160px;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            display: flex; justify-content: center; align-items: center;
            padding: 0 60px 20px 60px; /* 根據插畫調整文字位置 */
            box-sizing: border-box;
        }
        .advice-text { color: #fff; font-size: 1.2rem; line-height: 1.5; font-weight: 500; text-align: center; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }

        @keyframes sway { 0%, 100% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    </style>
</head>
<body>

<div class="ambient-layer" id="ambient-layer"></div>

<div class="container">
    <h1 id="title">Lumi's Asset Forest</h1>
    <div class="progress-bar-text" id="progress-text">Connecting to nature...</div>

    <div class="landscape">
        <div class="fountain-unit">
            <img id="fountain-img" class="fountain-img" src="" alt="Fountain">
            <div class="cash-status" id="cash-status">...</div>
        </div>

        <div class="orchard" id="orchard"></div>
    </div>

    <div class="signpost-area">
        <div id="signboard" class="signboard">
            <div class="advice-text" id="advice-text">...</div>
        </div>
    </div>
</div>

<script>
    const MY_PASSWORD = "lumi2026"; 
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQAnKIlc9Lf9PxSlb83nV1Wny7fC0EhKpy9iR41mMRqnLDepRpWwz8qyiIWaDEjY0TWaGLROfzeKbHG/pub?gid=768557640&single=true&output=csv";

    // --- 圖檔路徑設定 ---
    const ASSETS = {
        backgrounds: {
            "藍燈": "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/backgrounds/bg_winter_blue.jpg",
            "黃藍燈": "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/backgrounds/bg_early_spring.jpg",
            "綠燈": "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/backgrounds/bg_spring_green.jpg",
            "黃紅燈": "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/backgrounds/bg_late_summer.jpg",
            "紅燈": "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/backgrounds/bg_summer_red.jpg"
        },
        fountains: [
            "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/fountain/fountain_0_empty.png",
            "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/fountain/fountain_1_low.png",
            "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/fountain/fountain_2_mid.png",
            "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/fountain/fountain_3_high.png"
        ],
        progress_trees: {
            s: "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/trees/tree_progress_s.png",
            m: "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/trees/tree_progress_m.png",
            l: "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/trees/tree_progress_l.png"
        },
        stocks: {
            apple: "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/trees/stock_apple.png",
            orange: "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/trees/stock_orange.png",
            peach: "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/trees/stock_peach.png",
            banana: "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/trees/stock_banana.png",
            bush: "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/trees/stock_bush.png"
        },
        signpost: "https://raw.githubusercontent.com/evannyc/lumiinve/main/assets/ui/ui_signpost.png"
    };

    function start() {
        const pass = prompt("請輸入密碼開啟 Lumi 的繪本森林：");
        if (pass === MY_PASSWORD) {
            document.body.style.visibility = "visible";
            fetchData();
        } else { window.location.reload(); }
    }

    async function fetchData() {
        try {
            const resp = await fetch(csvUrl + "&t=" + Date.now());
            const text = await resp.text();
            const rows = text.split(/\r?\n/).map(r => r.split(',').map(c => c.replace(/["]+/g, '').trim()));
            const num = (v) => parseFloat(String(v).replace(/[^\d.-]/g, '')) || 0;
            
            const data = {
                assets: num(rows[0][1]), goal: num(rows[1][1]),
                cash: num(rows[2][1]), monthly: num(rows[3][1]),
                advice: rows[4][1], light: rows[5][1], stocks: []
            };

            for(let i=6; i<rows.length; i++) {
                if(rows[i][0]) data.stocks.push({ name: rows[i][0], val: num(rows[i][1]), alert: rows[i][2], type: rows[i][3] });
            }
            render(data);
        } catch(e) { console.error("Data error:", e); }
    }

    function render(d) {
        // 1. 背景與告示牌圖案
        document.body.style.backgroundImage = `url('${ASSETS.backgrounds[d.light] || ASSETS.backgrounds["綠燈"]}')`;
        document.getElementById('signboard').style.backgroundImage = `url('${ASSETS.signpost}')`;
        document.getElementById('advice-text').innerText = d.advice;

        // 2. 總進度文字與背景樹邏輯
        const progressPercent = (d.assets / d.goal) * 100;
        document.getElementById('progress-text').innerText = `Progress: ${progressPercent.toFixed(1)}% | Current Assets: $${d.assets.toLocaleString()}`;

        // 背景小樹 (根據進度決定階段與數量)
        const bgLayer = document.getElementById('ambient-layer');
        bgLayer.innerHTML = '';
        const treeType = progressPercent < 33 ? 's' : (progressPercent < 66 ? 'm' : 'l');
        const count = Math.min(Math.floor(progressPercent * 1.2), 100); 
        for(let i=0; i<count; i++) {
            const img = document.createElement('img');
            img.src = ASSETS.progress_trees[treeType];
            img.className = 'progress-tree';
            img.style.width = (30 + Math.random() * 40) + 'px';
            bgLayer.appendChild(img);
        }

        // 3. 噴水池等級切換
        const months = d.cash / d.monthly;
        let fLevel = 0;
        if (months >= 6) fLevel = 3;
        else if (months >= 3) fLevel = 2;
        else if (months >= 1) fLevel = 1;
        document.getElementById('fountain-img').src = ASSETS.fountains[fLevel];
        document.getElementById('cash-status').innerText = `現金支應：${months.toFixed(1)} 個月`;

        // 4. 前景果樹：依據 CSV 設定的 Type 與 市值比例
        const orchard = document.getElementById('orchard');
        orchard.innerHTML = '';
        const coreTypes = ['apple', 'orange', 'peach', 'banana'];
        
        d.stocks.forEach(s => {
            const type = coreTypes.includes(s.type) ? s.type : 'bush';
            const imgUrl = ASSETS.stocks[type];
            // 樹的大小基礎 (120px) + 市值權重增額 (最高 300px)
            const size = 120 + (s.val / d.assets) * 300;

            const unit = document.createElement('div');
            unit.className = 'tree-wrapper';
            unit.innerHTML = `
                <img class="tree-img" src="${imgUrl}" style="width:${size}px;">
                <div class="stock-label">
                    ${s.name}: ${s.val.toLocaleString()}
                    ${s.alert.includes("施肥") || s.alert.includes("加碼") ? '<span class="fertilize-tag">✨需施肥</span>' : ''}
                </div>
            `;
            orchard.appendChild(unit);
        });
    }

    start();
</script>
</body>
</html>

